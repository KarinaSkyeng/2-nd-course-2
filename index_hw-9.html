<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles_hw-9.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments">
        <!-- Комментарии -->
      </ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш комментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
    "use strict";
    document.addEventListener("DOMContentLoaded", () => {
  loadCommentsFromAPI();
});

// Найти элементы формы
const nameElement = document.querySelector(".add-form-name");
const textElement = document.querySelector(".add-form-text");
const buttonElement = document.querySelector(".add-form-button");
const commentsList = document.querySelector(".comments");

// Функция для загрузки списка комментариев из API
function loadCommentsFromAPI() {
  fetch("https://wedev-api.sky.pro/api/v1/karina-skyeng/comments")
    .then((response) => response.json())
    .then((data) => {
      // Обновляем отображение комментариев на странице
      renderComments(data.comments);
    })
    .catch((error) => {
      console.error("Ошибка при загрузке комментариев:", error);
    });
}

// Функция для добавления комментария в список и обновления отображения
function addComment() {
  const name = nameElement.value.trim();
  const text = textElement.value.trim();

  if (!name || !text) {
    highlightEmptyFields();
    return;
  }

  const newComment = {
    name: name,
    text: text,
  };

  const options = {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(newComment),
  };

  fetch("https://wedev-api.sky.pro/api/v1/karina-skyeng/comments", options)
    .then((response) => {
      if (!response.ok) {
        throw new Error("Ошибка при добавлении комментария");
      }
      return response.json();
    })
    .then((data) => {
      loadCommentsFromAPI();
    })
    .catch((error) => {
      console.error("Ошибка при добавлении комментария:", error);
    });
}

// Обработчик события для кнопки "Написать"
buttonElement.addEventListener("click", addComment);

// Функция для отрисовки всех комментариев
function renderComments(comments) {
  commentsList.innerHTML = "";

  comments.forEach((comment, index) => {
    const commentElement = createCommentElement(
      comment.author.name,
      comment.text,
      comment.date,
      comment.likes,
      comment.liked
    );

    commentsList.appendChild(commentElement);

    const likeButton = commentElement.querySelector(".like-button");
    likeButton.dataset.commentIndex = index;

    likeButton.addEventListener("click", () => {
      updateLikesState(likeButton, index);
    });
  });
}


      // Функция для обновления состояния лайка
      function updateLikesState(likeButton, commentIndex) {
        const comment = comments[commentIndex];

        comment.liked = !comment.liked;

        if (comment.liked) {
          comment.likes++;
        } else {
          comment.likes--;
        }

        renderComments(comments);
      }

      // Функция для создания элемента комментария
      function createCommentElement(name, text, date, likes, liked) {
        const comment = document.createElement("li");
        comment.classList.add("comment");

        const commentHTML = `
          <div class="comment-header">
            <div>${name}</div>
            <div>${date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">${text}</div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${likes}</span>
              <button class="like-button ${liked ? "-active-like" : ""}"></button>
            </div>
          </div>
        `;

        comment.innerHTML = commentHTML;

        return comment;
      }

      // Функция для подсветки пустых полей
      function highlightEmptyFields() {
        if (!nameElement.value.trim()) {
          nameElement.classList.add("error");
        } else {
          nameElement.classList.remove("error");
        }
        if (!textElement.value.trim()) {
          textElement.classList.add("error");
        } else {
          textElement.classList.remove("error");
        }
      }

      // Обработчик события для кнопки "Написать"
      buttonElement.addEventListener("click", () => {
        const name = nameElement.value.trim();
        const text = textElement.value.trim();

        if (!name || !text) {
          highlightEmptyFields();
          return;
        }

        // Очищаем поля формы
        nameElement.value = "";
        textElement.value = "";

        // Убираем подсветку пустых полей
        nameElement.classList.remove("error");
        textElement.classList.remove("error");
      });

      // Функция для получения текущей даты и времени
      function getCurrentDateTime() {
        const options = {
          day: "2-digit",
          month: "2-digit",
          year: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        };
        return new Date().toLocaleString("ru-RU", options).replace(",", "");
      }
  </script>
</html>
